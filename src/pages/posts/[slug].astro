---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import CallToAction from '../../components/CallToAction.astro';
import PostCard from '../../components/PostCard.astro';

import { formatDateBR } from '../../utils/formatDateBR';
import { getReadingTimeLabel } from '../../utils/readingTime';
import {
  getAuthorName,
  getAuthorProfile,
  getCoverPath,
  getPostSlug,
  slugifyTerm
} from '../../utils/postHelpers';

export async function getStaticPaths() {
  const posts = await getCollection('posts');

  return posts.map((post) => ({
    params: { slug: getPostSlug(post) },
    props: { post }
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

const { title, description, date, cover, category, author: authorId } = post.data;

const allPosts = await getCollection('posts');
const author = getAuthorProfile(authorId);
const coverPath = getCoverPath(cover);
const readingTime = getReadingTimeLabel(post.body);
const slug = getPostSlug(post);
const categorySlug = slugifyTerm(category);
const canonical = new URL(`/posts/${slug}/`, Astro.site ?? Astro.url).href;
const authorUrl = `/autores/${slugifyTerm(author.name)}/`;

const toCategoryList = (value: string | string[] | undefined) =>
  (Array.isArray(value) ? value : value ? [value] : []).map((item) =>
    slugifyTerm(item)
  );

const currentCategories = toCategoryList(category);

const relatedPosts = allPosts
  .filter((entry) => {
    const entrySlug = getPostSlug(entry);
    if (entrySlug === slug) return false;

    const entryCategories = toCategoryList(entry.data.category);
    return entryCategories.some((cat) =>
      currentCategories.includes(cat)
    );
  })
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 3);

const fallbackCover =
  'data:image/svg+xml;utf8,' +
  encodeURIComponent(`
<svg xmlns='http://www.w3.org/2000/svg' width='960' height='560'>
  <rect width='100%' height='100%' fill='#E9E2D8'/>
  <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'
        fill='#6F6355' font-size='34' font-family='Arial'>
    Capa indisponível
  </text>
</svg>
`);

const articleJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: title,
  description: description,
  datePublished: date,
  author: {
    '@type': 'Person',
    name: author.name
  },
  publisher: {
    '@type': 'Organization',
    name: 'Perspectiva Cristã'
  },
  mainEntityOfPage: canonical
};
---

<BaseLayout
  title={`${title} | Perspectiva Cristã`}
  description={description}
  image={coverPath}
  type="article"
  canonical={canonical}
>
  <script
    slot="head"
    type="application/ld+json"
    set:html={JSON.stringify(articleJsonLd)}
  />

  <article class="post">
    <header class="post-header">
      <h1>{title}</h1>

      <p class="meta">
        {formatDateBR(date)} •
        <a href={authorUrl}>{author.name}</a> •
        <a href={`/categorias/${categorySlug}/`}>{category}</a> •
        {readingTime}
      </p>

      {cover && (
        <img
          src={coverPath}
          alt={`Capa do artigo ${title}`}
          width="960"
          height="560"
          loading="lazy"
        />
      )}
    </header>

    <div class="content">
      <Content />
    </div>

    {relatedPosts.length > 0 && (
      <section class="related" aria-label="Continue explorando">
        <h2>Continue explorando</h2>

        <ul class="related-list">
          {relatedPosts.map((entry) => (
            <li>
              <PostCard
                url={`/posts/${getPostSlug(entry)}/`}
                cover={getCoverPath(entry.data.cover)}
                title={entry.data.title}
                formattedDate={formatDateBR(entry.data.date)}
                author={getAuthorName(entry.data.author)}
                readingTime={getReadingTimeLabel(entry.body)}
                fallbackCover={fallbackCover}
              />
            </li>
          ))}
        </ul>
      </section>
    )}

    <CallToAction />
  </article>
</BaseLayout>
